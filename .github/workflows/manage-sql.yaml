name: Manage Crossplane SQL
on:
  workflow_dispatch:
    inputs:
      action:
        description: Action to perform
        required: true
        type: choice
        options:
          - create
          - update
          - delete
      name:
        description: Database name
        required: true
      namespace:
        description: Namespace
        required: true
        default: a-team
      provider:
        description: Cloud provider
        required: false
        default: google
        type: choice
        options:
          - google
          - aws
          - azure
      region:
        description: Region
        required: false
        default: us-east1
      size:
        description: Instance size
        required: false
        default: small
        type: choice
        options:
          - small
          - medium
          - large
      version:
        description: PostgreSQL version
        required: false
        default: "16"
      port_run_id:
        description: Port action run ID
        required: true

jobs:
  manage-sql:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Report running
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          logMessage: "Starting ${{ inputs.action }} for SQL '${{ inputs.name }}' in namespace '${{ inputs.namespace }}'"

      - name: Create/Update manifest
        if: inputs.action != 'delete'
        run: |
          cat > apps/${{ inputs.name }}.yaml << 'MANIFEST'
          apiVersion: devopstoolkit.live/v1beta1
          kind: SQL
          metadata:
            name: ${{ inputs.name }}
            namespace: ${{ inputs.namespace }}
          spec:
            crossplane:
              compositionSelector:
                matchLabels:
                  db: postgresql
                  provider: ${{ inputs.provider }}
            region: ${{ inputs.region }}
            size: ${{ inputs.size }}
            version: "${{ inputs.version }}"
          MANIFEST

      - name: Delete manifest
        if: inputs.action == 'delete'
        run: |
          rm -f apps/${{ inputs.name }}.yaml

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "${{ inputs.action }} sql: ${{ inputs.name }}"
            git push
          fi

      - name: Report success
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "SUCCESS"
          logMessage: "Successfully completed ${{ inputs.action }} for SQL '${{ inputs.name }}'"

      - name: Report failure
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "FAILURE"
          logMessage: "Failed to ${{ inputs.action }} SQL '${{ inputs.name }}'"
