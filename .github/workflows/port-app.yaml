name: Manage App CRD
on:
  workflow_dispatch:
    inputs:
      action:
        description: Action to perform
        required: true
        type: choice
        options:
          - create
          - update
          - delete
      name:
        description: App name
        required: true
      namespace:
        description: Kubernetes namespace
        required: true
        default: a-team
      image:
        description: Container image
        required: false
      tag:
        description: Image tag
        required: false
      port:
        description: Application port
        required: false
        default: "8080"
      host:
        description: Host address
        required: false
      scaling_enabled:
        description: Enable scaling
        required: false
        default: "false"
      scaling_min:
        description: Minimum replicas
        required: false
        default: "1"
      scaling_max:
        description: Maximum replicas
        required: false
        default: "5"
      composition_type:
        description: Composition type
        required: false
        default: backend
      composition_location:
        description: Composition location
        required: false
        default: local
      port_run_id:
        description: Port action run ID
        required: true

jobs:
  manage-app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Report running status
        uses: port-labs/port-github-action@v1.7.8
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "RUNNING"
          logMessage: "Starting ${{ inputs.action }} for App '${{ inputs.name }}'"

      - name: Create/Update App manifest
        if: inputs.action != 'delete'
        run: |
          cat > apps/${{ inputs.name }}.yaml << 'EOF'
          apiVersion: devopstoolkit.live/v1beta1
          kind: App
          metadata:
            name: ${{ inputs.name }}
          spec:
            image: ${{ inputs.image }}
            tag: "${{ inputs.tag }}"
            port: ${{ inputs.port }}
            host: ${{ inputs.host }}
            scaling:
              enabled: ${{ inputs.scaling_enabled }}
              min: ${{ inputs.scaling_min }}
              max: ${{ inputs.scaling_max }}
            crossplane:
              compositionSelector:
                matchLabels:
                  type: ${{ inputs.composition_type }}
                  location: ${{ inputs.composition_location }}
          EOF

      - name: Delete App manifest
        if: inputs.action == 'delete'
        run: |
          rm -f apps/${{ inputs.name }}.yaml

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "${{ inputs.action }} App '${{ inputs.name }}'"
            git push
          fi

      - name: Report success
        if: success()
        uses: port-labs/port-github-action@v1.7.8
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "SUCCESS"
          logMessage: "Successfully completed ${{ inputs.action }} for App '${{ inputs.name }}'"

      - name: Report failure
        if: failure()
        uses: port-labs/port-github-action@v1.7.8
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "FAILURE"
          logMessage: "Failed to ${{ inputs.action }} App '${{ inputs.name }}'"
