name: Manage SQL CRD
on:
  workflow_dispatch:
    inputs:
      action:
        description: Action to perform
        required: true
        type: choice
        options:
          - create
          - update
          - delete
      name:
        description: SQL database name
        required: true
      namespace:
        description: Kubernetes namespace
        required: true
        default: a-team
      version:
        description: Database version
        required: false
        default: "13"
      size:
        description: Database size
        required: false
        default: small
        type: choice
        options:
          - small
          - medium
          - large
      region:
        description: Cloud region
        required: false
        default: us-east1
      provider:
        description: Cloud provider
        required: false
        default: google
        type: choice
        options:
          - google
          - aws
          - azure
      db_type:
        description: Database type
        required: false
        default: postgresql
        type: choice
        options:
          - postgresql
          - mysql
      port_run_id:
        description: Port action run ID
        required: true

jobs:
  manage-sql:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Report running status
        uses: port-labs/port-github-action@v1.7.8
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "RUNNING"
          logMessage: "Starting ${{ inputs.action }} for SQL '${{ inputs.name }}'"

      - name: Create/Update SQL manifest
        if: inputs.action != 'delete'
        run: |
          cat > apps/${{ inputs.name }}.yaml << 'EOF'
          apiVersion: devopstoolkit.live/v1beta1
          kind: SQL
          metadata:
            name: ${{ inputs.name }}
          spec:
            version: "${{ inputs.version }}"
            size: ${{ inputs.size }}
            region: ${{ inputs.region }}
            crossplane:
              compositionSelector:
                matchLabels:
                  provider: ${{ inputs.provider }}
                  db: ${{ inputs.db_type }}
          EOF

      - name: Delete SQL manifest
        if: inputs.action == 'delete'
        run: |
          rm -f apps/${{ inputs.name }}.yaml

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "${{ inputs.action }} SQL '${{ inputs.name }}'"
            git push
          fi

      - name: Report success
        if: success()
        uses: port-labs/port-github-action@v1.7.8
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "SUCCESS"
          logMessage: "Successfully completed ${{ inputs.action }} for SQL '${{ inputs.name }}'"

      - name: Report failure
        if: failure()
        uses: port-labs/port-github-action@v1.7.8
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "FAILURE"
          logMessage: "Failed to ${{ inputs.action }} SQL '${{ inputs.name }}'"
